function TableBind(options){var opts=$.extend({ajaxOptons:{url:null},table:null,data:[],key:null,rowCss:"even_color",hoverCss:"trhover",alternatelyCss:"odd_color",selectedCss:"",showMask:true,onBind:function(data){},beforeRowBind:function(data){},afterRowBind:function(data,tr){},onSelectedRow:function(oldTr,newTr){},onMoveRow:function(oldTr,newTr,isUp){},onDelete:function(data){}},options);this.CheckAllBoxSelecter=null;this.GetOptions=function(){return opts};function _init(that){if(opts.table==null){that.tableloader.Remove();return that}else{opts.table=$(opts.table)}_Clear();if(opts.data.length==0){that.tableloader.Remove();return that}if(opts.key==null){that.tableloader.Remove();return that}opts.onBind(opts.data);that.InsertRow(opts.data);this.CheckAllBoxSelecter=UI.CheckAllbox(opts.table,".checkall");if(!!that.tableloader){that.tableloader.Remove()}return true}this.FormatTemplate=function(template,data){for(var column in data){var pattern=new RegExp(eval("/{"+column+"}/g"));if(pattern.test(template)){template=template.replace(pattern,data[column])}}template=$(template);var id=(opts.table.attr("id")||Math.round(Math.random(100)*100/100))+data[opts.key];template.attr("id",id);template.attr("key",data[opts.key]);return template};this.ChangeTemplate=function(template){template=$(template);$("tr[template='true']",opts.table).html(template.html());if(opts.data.length==0){$(".nodatarow",opts.table).remove();setNoDataRow()}};this.GetItemByKey=function(key){return $("tr[key='"+key+"']",opts.table)};this.GetDateByKey=function(key){for(var i=0;i<opts.data;i++){if(data[i][opts.key]==key){return data[i]}}return null};this.UpdateRow=function(newData){opts.beforeRowBind(newData);var template=$("tr[template='true']",opts.table)[0].outerHTML;var templateRow=this.FormatTemplate(template,row);var tr=this.GetDateByKey(newdata[opts.key]);tr.html($(templateRow).html());opts.afterRowBind(tr);for(var i=0;i<opts.data;i++){if(opts.data[i][opts.key]==newData[opts.key]){opts.data[i]=newData;break}}};this.DelRow=function(key){if(opts.onDelete(key)==false){return null}var deleteKeys=new Array();if(typeof(key)=="string"||typeof(key)=="number"){this.GetItemByKey(key).remove();deleteKeys.push(key)}else{$(key).each(function(i,e){key=$(e).attr("key");deleteKeys.push(key);if($(e).attr("template")==null){$(e).remove()}})}$(deleteKeys).each(function(index,item){for(var i=0;i<opts.data.length;i++){if(opts.data[i][opts.key]==item){opts.data.splice(i,1);i--}}});_setTableBackGroundColor();if(opts.data.length==0){setNoDataRow()}return true};this.GetTrKeyValue=function(tr){return $(tr,opts.table).attr("key")};this.InsertRow=_insert;this.Selected=function(key){var oldTr=this.GetCurrentRow();var tr=GetItemByKey(key);_setSelectRow(tr);opts.onSelectedRow(oldTr,tr);return tr};this.GetCurrentRow=function(){return $("tr.selected",opts.table)};this.GetSelectItems=function(){var items=null;if(this.CheckAllBoxSelecter==null&&this.GetCurrentRow().length>0){items=[this.GetCurrentRow()]}else{items=this.CheckAllBoxSelecter.GetCheckboxSelectedItem()}return items};this.Move=function(isUp){var tr=this.GetCurrentRow();if($(tr).length==0){return false}var oldTr;if(isUp){oldTr=$(tr).prev();if(oldTr.length==0){return false}oldTr.before($(tr))}else{oldTr=$(tr).next();if(oldTr.length==0){return false}oldTr.after($(tr))}opts.onMoveRow(oldTr,tr,isUp);_setTableBackGroundColor();if(tr.hasClass(opts.selectedCss)){$(tr).removeClass(opts.rowCss);$(tr).removeClass(opts.alternatelyCss)}};this.Clear=function(){_Clear();opts.data=[]};function _Clear(){$("tr",opts.table).each(function(i,e){if($(e).parent()[0].tagName.toLowerCase()=="tbody"){$(e).remove()}});setNoDataRow()}function setNoDataRow(){var panel;if($("tbody",opts.table).length>0){panel=$("tbody",opts.table)}else{panel=opts.table}var colspanNum=$("tr[template='true']",opts.table).children().length;var panelTdClass=$("tr[template='true']",opts.table).children("td:first").attr("class");if(panelTdClass){panelTdClass=panelTdClass.replace("align_c","").replace("align_r","")}panel.append('<tr class="nodatarow p10_l"><td colspan="'+colspanNum+'" class="'+panelTdClass+' align_l">暂无数据</td></tr>')}function _insert(dataSource){var $that=this;var insertDataList=new Array();$(dataSource).each(function(index,data){if(!!$(".nodatarow",opts.table)){$(".nodatarow",opts.table).remove()}opts.beforeRowBind(data);if($("tr[key='"+data[opts.key]+"']",opts.table).length>0){return}var template=$("tr[template='true']",opts.table)[0].outerHTML;var templateRow=$that.FormatTemplate(template,data);templateRow.attr("template",null);templateRow.show();var panel;if($("tbody",opts.table).length>0){panel=$("tbody",opts.table)}else{panel=opts.table}panel.append(templateRow);opts.afterRowBind(templateRow);templateRow.click(function(){_setSelectRow($(this))});_setTableBackGroundColor();$that.CheckAllBoxSelecter=UI.CheckAllbox(opts.table,".checkall");insertDataList.push(data)});$(insertDataList).each(function(index,item){for(var i=0;i<opts.data.length;i++){if(opts.data[i][opts.key]==item[opts.key]){return false}}opts.data.push(item)})}function _setSelectRow(tr){if(opts.selectedCss==null){return false}var parentTable=$(tr).parent();if(parentTable[0].tagName.toLowerCase()=="thead"){return false}while(parentTable[0].tagName.toLowerCase()!="table"){if(parentTable[0].tagName.toLowerCase()=="body"){return false}parentTable=parentTable.parent()}if(parentTable.children("tbody").length>0){parentTable=parentTable.children("tbody")}this.GetCurrentRow().each(function(i,e){$(e).removeClass(opts.selectedCss)});_setTableBackGroundColor();$(tr).removeClass(opts.rowCss);$(tr).removeClass(opts.alternatelyCss);$(tr).addClass(opts.selectedCss)}function _setTableBackGroundColor(){$("tr",opts.table).removeClass(opts.rowCss);$("tr",opts.table).removeClass(opts.alternatelyCss);$("tr:odd",opts.table).addClass(opts.rowCss);$("tr:even",opts.table).addClass(opts.alternatelyCss);$("tr",opts.table).hover(function(){$(this).addClass(opts.hoverCss)},function(){$(this).removeClass(opts.hoverCss)});return true}this.tableloader={};if(opts.showMask&&!!opts.table){this.tableloader=UI.Mask({obj:$(opts.table),zindex:1000})}else{this.tableloader.Remove=function(){return false}}if(opts.ajaxOptons.url!=null){var that=this;if(opts.ajaxOptons.data){for(var key in opts.ajaxOptons.data){if(opts.ajaxOptons.data[key]!=null&&typeof(opts.ajaxOptons.data[key])=="object"){opts.ajaxOptons.data[key]=JSON.stringify(opts.ajaxOptons.data[key])}}}opts.ajaxOptons.success=function(data){if(data==null){return false}opts.data=data;_init(that);tableloader.Remove();return true};opts.ajaxOptons.error=function(XMLHttpRequest,textStatus,errorThrown){if($.isFunction(opts.ajaxOptons.error)){opts.ajaxOptons.error(XMLHttpRequest,textStatus,errorThrown)}else{var error=JSON.parse(XMLHttpRequest.responseText);alert(error.ErrorMessage)}this.tableloader.Remove()};var ajaxoptions={};ajaxoptions=$.extend(opts.ajaxOptons,ajaxoptions);$.ajax(ajaxoptions)}else{_init(this)}return this};